openapi: 3.0.0

info:
  version: 0.5.2
  title: Inertia Daemon API
  description: The Inertia daemon's REST API
  contact:
    name: UBC Launch Pad
    email: team@ubclaunchpad.com
    url: https://github.com/ubclaunchpad/inertia
  license:
    name: MIT
    url: https://github.com/ubclaunchpad/inertia/blob/master/LICENSE

servers:
  - url: https://$DAEMON_ADDR:$DAEMON_PORT

paths:
  /:
    get:
      summary: Daemon healthcheck
      description: Returns OK if daemon is online and ready
      responses:
        200:
          description: Daemon is online
          content:
            text/plain:
              type: string
              example: Hello world!

  /webhook:
    post:
      summary: Webhook endpoint
      description: Accepts incoming payloads from Git hosts
      responses:
        202:
          $ref: '#/components/responses/OK'
        4XX,5XX:
          $ref: '#/components/responses/Error'

  /status:
    get:
      summary: Deployment status check
      description: Check deployment status
      responses:
        200:
          description: hello world
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/OKResponse'
        4XX,5XX:
          $ref: '#/components/responses/Error'

  /up:
    post:
      summary: Start up project
      description: Build and deploys your project
      responses:
        201:
          description: 'Project deployment successfully started'
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/OKResponse'
        4XX,5XX:
          $ref: '#/components/responses/Error'

  /down:
    post:
      summary: Shut down project
      description: Shuts down project containers
      responses:
        200:
          $ref: '#/components/responses/OK'
        4XX,5XX:
          $ref: '#/components/responses/Error'

  /reset:
    post:
      summary: Remove project
      description: Reset daemon and remove project from deployment
      responses:
        200:
          $ref: '#/components/responses/OK'
        4XX,5XX:
          $ref: '#/components/responses/Error'

  /env:
    post:
      summary: Update environment variables
      description: asdf
      responses:
        202:
          $ref: '#/components/responses/OK'
        4XX,5XX:
          $ref: '#/components/responses/Error'
    get:
      summary: Retrieve environment variables
      description: asdf
      responses:
        200:
          description: Success!
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/OKResponse'
                  - type: object
                    required: [ data ]
                    properties:
                      data:
                        type: object
                        required: [ variables ]
                        properties:
                          variables:
                            type: array
                            items:
                              type: string
                            example: [ KEY1=VAL1, KEY2=VAL2 ]
                            description: all currently set environment variables in KEY=VALUE pairs
        4XX,5XX:
          $ref: '#/components/responses/Error'

  # auth

  /user/validate:
    get:
      summary: Validate token
      description: asdf
      responses:
        200:
          $ref: '#/components/responses/OK'
        4XX,5XX:
          $ref: '#/components/responses/Error'
  /user/login:
    post:
      summary: Log in as user
      description: Authenticate as a user to Inertia daemon
      responses:
        200:
          description: Success!
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/OKResponse'
                  - type: object
                    required: [ data ]
                    properties:
                      data:
                        type: object
                        required: [ token ]
                        properties:
                          token:
                            type: string
                            example: abcdefg
                            description: JWT for API access
        4XX,5XX:
          $ref: '#/components/responses/Error'
  /user/list:
    get:
      summary: List users
      description: List all currently registered users on the Inertia daemon
      responses:
        200:
          description: Success!
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/OKResponse'
                  - type: object
                    required: [ data ]
                    properties:
                      data:
                        type: object
                        required: [ users ]
                        properties:
                          users:
                            type: array
                            items:
                              type: string
                            example: [ bobheadxi, mRabitsky, seifghazi, terryz21, theblackathena, yaoharry ]
                            description: list of currently registered users
        4XX,5XX:
          $ref: '#/components/responses/Error'
  /user/add:
    post:
      summary: Add user
      description: Register a new user in the Inertia daemon
      responses:
        201:
          $ref: '#/components/responses/OK'
        4XX,5XX:
          $ref: '#/components/responses/Error'
  /user/remove:
    post:
      summary: Remove user
      description: Unregister a user from the Inertia daemon
      responses:
        200:
          $ref: '#/components/responses/OK'
        4XX,5XX:
          $ref: '#/components/responses/Error'

  /user/reset:
    post:
      summary: Reset all users
      description: Remove all users from the Inertia daemon
      responses:
        200:
          $ref: '#/components/responses/OK'
        4XX,5XX:
          $ref: '#/components/responses/Error'

  /user/totp/enable:
    post:
      summary: Enable 2FA for user
      description: Enables TOTP-based 2FA for the given user
      responses:
        200:
          description: '2FA successfully enabled for user'
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/OKResponse'
                  - type: object
                    required: [ data ]
                    properties:
                      data:
                        type: object
                        required: [ secret, backup_codes ]
                        properties:
                          secret:
                            type: string
                            example: secret_key
                            description: TOTP secret key
                          backup_codes:
                            type: array
                            items:
                              type: string
                            example: [ code1, code2, code3 ]
                            description: TOTP backup codes
        4XX,5XX:
          $ref: '#/components/responses/Error'

  /user/totp/disable:
    post:
      summary: Disable 2FA for user
      description: Disable TOTP-based 2FA for the given user
      responses:
        200:
          $ref: '#/components/responses/OK'
        4XX,5XX:
          $ref: '#/components/responses/Error'

components:
  responses:
    OK:
      description: Success!
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/OKResponse'
    Error:
      description: Something went wrong - refer to the error code and message for more details
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrResponse'
  schemas:
    OKResponse:
      required: [ code, message ]
      properties:
        code:
          type: integer
          description: HTTP status code
        message:
          type: string
          example: (example) successfully did something!
          description: summary of response
        request_id:
          type: string
          example: example/2Mch7LMzhj-000023
          description: generated request ID corresponding to request
        data:
          type: object
          additionalProperties: true
          description: response data and additional context
    ErrResponse:
      required: [ code, message, error ]
      properties:
        code:
          type: integer
          description: HTTP status code
        message:
          type: string
          example: (example) could not do something
          description: summary of response
        error:
          type: string
          example: (example) value x is missing
          description: detailed about error message
        request_id:
          type: string
          example: example/2Mch7LMzhj-000023
          description: generated request ID corresponding to request
        data:
          type: object
          additionalProperties: true
          description: additional context about error
          example:
            example: here is some additional information
